import"./style-Dz1zmf2x.js";import{initializeApp as ae}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as re,doc as w,deleteDoc as oe,getDoc as Z,updateDoc as ne,setDoc as I,serverTimestamp as se,query as ie,collection as ce,orderBy as de,getDocs as le}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as ue,sendSignInLinkToEmail as me,signOut as J,isSignInWithEmailLink as pe,signInWithEmailLink as ve,onAuthStateChanged as ge}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const fe={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},U=ae(fe),g=re(U),v=ue(U),X="biosistem@gmail.com",o=e=>document.getElementById(e),x=o("loginBox"),D=o("appBox"),ye=o("email"),C=o("sendLinkBtn"),u=o("loginMsg"),H=o("title"),m=o("openAt"),O=o("startDate"),j=o("endDate"),he=o("amDays"),be=o("pmDays"),A=o("openNowBtn"),B=o("scheduleBtn"),N=o("closeBtn"),_=o("saveWindowBtn"),l=o("appMsg"),Y=o("stateBadge"),M=o("stateDesc"),T=o("logoutBtn"),p=o("reservasTbody"),E=o("resName"),k=o("resDate"),S=o("resSlot"),L=o("resPerson"),F=o("resUpdateBtn"),$=o("resClearBtn"),c=o("resMsg"),y=w(g,"settings","visitStatus");let f=null;const G=[{label:"L",value:1},{label:"M",value:2},{label:"X",value:3},{label:"J",value:4},{label:"V",value:5},{label:"S",value:6},{label:"D",value:0}];function ee(e,a){if(e){e.innerHTML="";for(let r=0;r<G.length;r++){const t=G[r],s=document.createElement("label");s.className="flex items-center gap-1";const i=document.createElement("input");i.type="checkbox",i.value=String(t.value),i.dataset.group=a,t.value===2&&(i.disabled=!0,s.className+=" text-zinc-400",s.title="Martes no disponible."),s.appendChild(i),s.appendChild(document.createTextNode(t.label)),e.appendChild(s)}}}ee(he,"am");ee(be,"pm");function W(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(a=>Number(a.value)))}function b(e,a=[]){const r=new Set((a||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(t=>{t.checked=r.has(Number(t.value))})}function z(e){const a={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};Y.textContent=e||"—",Y.className=`px-2 py-0.5 rounded-lg text-white text-xs ${a[e]||"bg-zinc-600"}`}function n(e,a,r=""){e.textContent=a||"",e.className="text-sm mt-2 "+(r==="error"?"text-red-600":r==="ok"?"text-green-700":"text-zinc-600")}async function we(){ge(v,async e=>{e&&e.email===X?(x.classList.add("hidden"),D.classList.remove("hidden"),await h()):e?(n(u,"Este correo no tiene acceso.","error"),await J(v),x.classList.remove("hidden"),D.classList.add("hidden")):(x.classList.remove("hidden"),D.classList.add("hidden"))})}C==null||C.addEventListener("click",async()=>{const e=(ye.value||"").trim();if(e.toLowerCase()!==X){n(u,"Solo el administrador puede acceder.","error");return}if(!e){n(u,"Escribe tu correo.","error");return}n(u,"Enviando enlace…");const a={url:window.location.href,handleCodeInApp:!0};try{await me(v,e,a),window.localStorage.setItem("emailForSignIn",e),n(u,"Revisa tu correo y abre el enlace para entrar.","ok")}catch(r){n(u,"No se pudo enviar el enlace.","error"),console.error(r)}});T==null||T.addEventListener("click",async()=>{await J(v),location.reload()});async function h(){var e,a;try{const r=await Z(y);if(r.exists()){const t=r.data();z(t.state),M.textContent=t.state==="active"?"La visita esta abierta. El formulario es visible.":t.state==="scheduled"?"Apertura programada; aun no abre.":t.state==="concluded"?"La visita concluyo.":"Aun no hay visita programada.",H.value=t.title||"Visita SC",O.value=t.start_date||"",j.value=t.end_date||"",(e=t.open_at)!=null&&e.toDate?m.value=t.open_at.toDate().toISOString().slice(0,16):(a=t.open_at)!=null&&a.seconds?m.value=new Date(t.open_at.seconds*1e3).toISOString().slice(0,16):m.value="",b("am",t.am_days||[]),b("pm",t.pm_days||[])}else z("noscheduled"),M.textContent="Aun no hay visita programada.",H.value="Visita SC",m.value="",O.value="",j.value="",b("am",[]),b("pm",[])}catch(r){console.error("Error loading status:",r),z("noscheduled"),M.textContent="No se pudo leer el estado."}await K()}function te(){f=null,E&&(E.value=""),k&&(k.value=""),S&&(S.value="AM"),L&&(L.value="SC"),c&&n(c,"")}async function K(){if(p){p.innerHTML="";try{const e=ie(ce(g,"reservas"),de("date","asc"));(await le(e)).forEach(r=>{const t=r.data(),s=document.createElement("tr");s.innerHTML=`
        <td>${t.date||""}</td>
        <td>${t.slot||""}</td>
        <td>${t.person||""}</td>
        <td>${t.name||""}</td>
        <td>
          <button data-edit="${r.id}" class="px-2 py-1 border rounded">Editar</button>
          <button data-delete="${r.id}" class="px-2 py-1 border rounded">Eliminar</button>
        </td>
      `,p.appendChild(s)})}catch(e){console.error("Error fetching reservas:",e),n(c,"No se pudieron cargar las reservas.","error")}}}p==null||p.addEventListener("click",async e=>{const a=e.target.closest("button[data-edit]"),r=e.target.closest("button[data-delete]");if(!(!a&&!r)){if(r){const t=r.dataset.delete;if(!t||!confirm("Eliminar esta reserva?"))return;try{await oe(w(g,"reservas",t)),n(c,"Reserva eliminada.","ok"),f===t&&te(),await K()}catch(i){console.error(i),n(c,"No se pudo eliminar.","error")}return}if(a){const t=a.dataset.edit;if(!t)return;try{const s=await Z(w(g,"reservas",t));if(!s.exists())return;const i=s.data();f=t,E.value=i.name||"",k.value=i.date||"",S.value=i.slot||"AM",L.value=i.person||"SC",n(c,"Editando reserva seleccionada.","ok")}catch(s){console.error(s),n(c,"No se pudo cargar la reserva.","error")}}}});F==null||F.addEventListener("click",async()=>{if(!f){n(c,"Selecciona una reserva para editar.","error");return}const e={name:(E.value||"").trim(),date:k.value,slot:S.value,person:L.value};if(!e.name||!e.date||!e.slot||!e.person){n(c,"Completa todos los campos.","error");return}try{await ne(w(g,"reservas",f),e),n(c,"Reserva actualizada.","ok"),await K()}catch(a){console.error(a),n(c,"No se pudo actualizar.","error")}});$==null||$.addEventListener("click",()=>{te()});A==null||A.addEventListener("click",async()=>{try{await I(y,{state:"active",open_at:se()},{merge:!0}),n(l,"Visita abierta desde ahora.","ok"),await h()}catch(e){n(l,"No se pudo abrir.","error"),console.error(e)}});B==null||B.addEventListener("click",async()=>{if(!m.value){n(l,"Selecciona fecha/hora en 'Publicar en'.","error");return}try{await I(y,{state:"scheduled",open_at:new Date(m.value)},{merge:!0}),n(l,"Apertura programada.","ok"),await h()}catch(e){n(l,"No se pudo programar apertura.","error"),console.error(e)}});N==null||N.addEventListener("click",async()=>{try{await I(y,{state:"concluded"},{merge:!0}),n(l,"Visita cerrada.","ok"),await h()}catch(e){n(l,"No se pudo cerrar.","error"),console.error(e)}});_==null||_.addEventListener("click",async()=>{const e=O.value,a=j.value;if(!e||!a){n(l,"Define inicio y fin.","error");return}const r=[...W("am")],t=[...W("pm")],s={title:H.value||"Visita SC",start_date:e,end_date:a,am_days:r,pm_days:t};try{await I(y,s,{merge:!0}),n(l,"Rango y dias guardados.","ok"),await h()}catch(i){n(l,"No se pudo guardar.","error"),console.error(i)}});const q=document.getElementById("helpBtn"),d=document.getElementById("helpModal"),P=document.getElementById("helpClose"),R=document.getElementById("helpClose2"),V=document.getElementById("helpCopy");function Ee(){d==null||d.classList.remove("hidden")}function Q(){d==null||d.classList.add("hidden")}q==null||q.addEventListener("click",Ee);P==null||P.addEventListener("click",Q);R==null||R.addEventListener("click",Q);d==null||d.addEventListener("click",e=>{e.target===d&&Q()});V==null||V.addEventListener("click",async()=>{const e=["1) Crear nueva visita (queda cerrada).","2) Configura Título, Inicio/Fin y AM/PM. Pulsa Guardar rango/días.","3) Abrir ahora (visible inmediato) o Programar apertura con fecha/hora.","4) Verifica Estado: active o scheduled.","5) En la pública recarga; si está active y el día aplica, podrán reservar.","6) Al terminar, Cerrar (o deja que pase Fin)."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){if(pe(v,window.location.href)){let a=window.localStorage.getItem("emailForSignIn");if(a||(a=window.prompt("Por favor, proporciona tu correo para confirmar tu inicio de sesión.")),a)try{const r=await ve(v,a,window.location.href);window.localStorage.removeItem("emailForSignIn")}catch(r){console.error("Error signing in with email link",r)}}await we()})();
