import"./style-Dz1zmf2x.js";import{initializeApp as Ce}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as Me,doc as N,deleteDoc as Ee,getDoc as ce,updateDoc as we,getDocs as Le,collection as ke,setDoc as A,serverTimestamp as Be,query as Te,orderBy as ze}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as Pe,signInWithEmailAndPassword as Ie,signOut as Se,onAuthStateChanged as Ve}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const qe={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},De=Ce(qe),g=Me(De),z=Pe(De),Re="biosistem@gmail.com",_e=Re.trim().toLowerCase(),n=e=>document.getElementById(e),B=n("loginBox"),T=n("appBox"),Fe=n("email"),l=n("password"),$=n("showPassword"),h=n("loginBtn"),v=n("loginMsg"),f=n("title"),H=n("saveTitleBtn"),C=n("titleMsg"),P=n("openAt"),k=n("startDate"),S=n("endDate"),D=n("visitStartDate"),_=n("visitEndDate"),Oe=n("amDays"),He=n("pmDays"),Y=n("openNowBtn"),j=n("scheduleBtn"),J=n("closeBtn"),K=n("saveWindowBtn"),c=n("appMsg"),ve=n("stateBadge"),Q=n("stateDesc"),pe=n("stateSummary"),W=n("logoutBtn"),E=n("reservasTbody"),I=n("resName"),V=n("resDate"),q=n("resSlot"),R=n("resPerson"),Z=n("resUpdateBtn"),G=n("resClearBtn"),X=n("resDeleteAllBtn"),d=n("resMsg"),b=n("confirmModal"),fe=n("confirmText"),U=n("confirmYesBtn"),ee=n("confirmNoBtn"),p=N(g,"settings","visitStatus");let x=null;const Ye={1:"L",2:"M",3:"X",4:"J",5:"V",6:"S",0:"D"},de=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],ge=[{label:"L",value:1},{label:"M",value:2},{label:"X",value:3},{label:"J",value:4},{label:"V",value:5},{label:"S",value:6},{label:"D",value:0}];function Ne(e,r){if(e){e.innerHTML="";for(let a=0;a<ge.length;a++){const t=ge[a],s=document.createElement("label");s.className="flex items-center gap-1";const i=document.createElement("input");i.type="checkbox",i.value=String(t.value),i.dataset.group=r,t.value===2&&(i.disabled=!0,s.className+=" text-zinc-400",s.title="Martes no disponible."),s.appendChild(i),s.appendChild(document.createTextNode(t.label)),e.appendChild(s)}}}Ne(Oe,"am");Ne(He,"pm");function ye(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(r=>Number(r.value)))}function M(e,r=[]){const a=new Set((r||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(t=>{t.checked=a.has(Number(t.value))})}function te(e){const r={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};ve.textContent=e||"—",ve.className=`px-2 py-0.5 rounded-lg text-white text-xs ${r[e]||"bg-zinc-600"}`}function o(e,r,a=""){e.textContent=r||"",e.className="text-sm mt-2 "+(a==="error"?"text-red-600":a==="ok"?"text-green-700":"text-zinc-600")}function be(e=[]){const r=[...new Set((e||[]).map(Number).filter(t=>t!==2))],a={1:1,2:2,3:3,4:4,5:5,6:6,0:7};return r.sort((t,s)=>(a[t]||99)-(a[s]||99)),r.length?r.map(t=>Ye[t]||String(t)).join(", "):"—"}function je(e){if(!e)return"—";const r=new Date(e);if(Number.isNaN(r.getTime()))return e;const a=r.getDate(),t=de[r.getMonth()]||"",s=r.getHours(),i=String(r.getMinutes()).padStart(2,"0"),m=String(r.getSeconds()).padStart(2,"0"),y=s>=12?"p.m.":"a.m.",O=s%12||12;return`${a} de ${t} a las ${O}:${i}:${m} ${y}`}function he(e){if(!e)return"—";const[r,a,t]=e.split("-").map(Number);if(!r||!a||!t)return e;const s=de[a-1]||"";return`${t} de ${s}`}function ie(e,r){if(!e||!r)return"—";const[a,t,s]=e.split("-").map(Number),[i,m,y]=r.split("-").map(Number);return!a||!t||!s||!i||!m||!y?`${e} al ${r}`:a===i&&t===m?`${s} al ${y} de ${de[t-1]||""}`:`${he(e)} al ${he(r)}`}function Je(e){return{active:"Abierta",scheduled:"Programada",concluded:"Cerrada",noscheduled:"Sin programar"}[e]||"—"}function re(e={}){if(!pe)return;const r=["Ventana de reservas:",`- Titulo: ${e.title||"—"}`,"- Periodo de visita:",`${ie(e.visit_start_date,e.visit_end_date)}`,"- Reservas del:",`${ie(e.start_date,e.end_date)}`,`- Dias AM (citas): ${be(e.am_days||[])}`,`- Dias PM (citas): ${be(e.pm_days||[])}`,"","Publicacion:",`- Estado: ${Je(e.state)}`,"- Publicar el:",`${je(e.open_at_summary||"")}`];pe.textContent=r.join(`
`)}function xe(){return{start:(k==null?void 0:k.value)||"",end:(S==null?void 0:S.value)||"",visitStart:(D==null?void 0:D.value)||"",visitEnd:(_==null?void 0:_.value)||""}}function le(){const{start:e,end:r,visitStart:a,visitEnd:t}=xe();return!e||!r?"Define inicio y fin de reservas.":!a||!t?"Define inicio y fin de visita.":e>r?"El inicio de reservas no puede ser mayor al fin.":a>t?"El inicio de visita no puede ser mayor al fin.":""}function Ae(e){return new Promise(r=>{if(!b||!fe||!U||!ee){r(window.confirm(e));return}fe.textContent=e,b.classList.remove("hidden");const a=m=>{b.classList.add("hidden"),U.removeEventListener("click",t),ee.removeEventListener("click",s),b.removeEventListener("click",i),r(m)},t=()=>a(!0),s=()=>a(!1),i=m=>{m.target===b&&a(!1)};U.addEventListener("click",t),ee.addEventListener("click",s),b.addEventListener("click",i)})}async function Ke(){Ve(z,async e=>{const r=((e==null?void 0:e.email)||"").trim().toLowerCase();e&&r===_e?(B.classList.add("hidden"),T.classList.remove("hidden"),await w()):e?(o(v,"Este correo no tiene acceso.","error"),await Se(z),B.classList.remove("hidden"),T.classList.add("hidden")):(B.classList.remove("hidden"),T.classList.add("hidden"))})}h==null||h.addEventListener("click",async()=>{const e=(Fe.value||"").trim().toLowerCase(),r=((l==null?void 0:l.value)||"").trim();if(!e||!r){o(v,"Escribe correo y contraseña.","error");return}if(e!==_e){o(v,"Solo el administrador puede acceder.","error");return}o(v,"Ingresando...");try{await Ie(z,e,r),l&&(l.value=""),o(v,"Acceso correcto.","ok")}catch(a){const t=(a==null?void 0:a.code)||"";t==="auth/invalid-credential"||t==="auth/wrong-password"||t==="auth/user-not-found"?o(v,"Correo o contraseña incorrectos.","error"):t==="auth/too-many-requests"?o(v,"Demasiados intentos. Espera un momento e intenta de nuevo.","error"):o(v,`No se pudo iniciar sesión (${t||"sin-codigo"}).`,"error"),console.error("Login error:",t,a)}});l==null||l.addEventListener("keydown",e=>{e.key==="Enter"&&(e.preventDefault(),h==null||h.click())});$==null||$.addEventListener("change",()=>{l&&(l.type=$.checked?"text":"password")});W==null||W.addEventListener("click",async()=>{try{await Se(z),o(v,""),B.classList.remove("hidden"),T.classList.add("hidden")}catch(e){o(c,"No se pudo cerrar sesión.","error"),console.error("Logout error:",e)}});async function w(){var e,r;try{const a=await ce(p);if(a.exists()){const t=a.data();te(t.state),Q.textContent=t.state==="active"?"La visita esta abierta. El formulario es visible.":t.state==="scheduled"?"Apertura programada; aun no abre.":t.state==="concluded"?"La visita concluyo.":"Aun no hay visita programada.",f.value=t.title||"Visita SC",k.value=t.start_date||"",S.value=t.end_date||"",D.value=t.visit_start_date||"",_.value=t.visit_end_date||"";let s="";(e=t.open_at)!=null&&e.toDate?s=t.open_at.toDate().toISOString().slice(0,16):(r=t.open_at)!=null&&r.seconds&&(s=new Date(t.open_at.seconds*1e3).toISOString().slice(0,16)),P.value=s,M("am",t.am_days||[]),M("pm",t.pm_days||[]),re({...t,open_at_summary:s})}else te("noscheduled"),Q.textContent="Aun no hay visita programada.",f.value="Visita SC",P.value="",k.value="",S.value="",D.value="",_.value="",M("am",[]),M("pm",[]),re({})}catch(a){console.error("Error loading status:",a),te("noscheduled"),Q.textContent="No se pudo leer el estado.",re({})}await F()}function ue(){x=null,I&&(I.value=""),V&&(V.value=""),q&&(q.value="AM"),R&&(R.value="SC"),d&&o(d,"")}async function F(){if(E){E.innerHTML="";try{const e=Te(ke(g,"reservas"),ze("date","asc"));(await Le(e)).forEach(a=>{const t=a.data(),s=document.createElement("tr");s.innerHTML=`
        <td>${t.date||""}</td>
        <td>${t.slot||""}</td>
        <td>${t.person||""}</td>
        <td>${t.name||""}</td>
        <td>
          <button data-edit="${a.id}" class="px-2 py-1 border rounded">Editar</button>
          <button data-delete="${a.id}" class="px-2 py-1 border rounded">Eliminar</button>
        </td>
      `,E.appendChild(s)})}catch(e){console.error("Error fetching reservas:",e),o(d,"No se pudieron cargar las reservas.","error")}}}E==null||E.addEventListener("click",async e=>{const r=e.target.closest("button[data-edit]"),a=e.target.closest("button[data-delete]");if(!(!r&&!a)){if(a){const t=a.dataset.delete;if(!t||!confirm("Eliminar esta reserva?"))return;try{await Ee(N(g,"reservas",t)),o(d,"Reserva eliminada.","ok"),x===t&&ue(),await F()}catch(i){console.error(i),o(d,"No se pudo eliminar.","error")}return}if(r){const t=r.dataset.edit;if(!t)return;try{const s=await ce(N(g,"reservas",t));if(!s.exists())return;const i=s.data();x=t,I.value=i.name||"",V.value=i.date||"",q.value=i.slot||"AM",R.value=i.person||"SC",o(d,"Editando reserva seleccionada.","ok")}catch(s){console.error(s),o(d,"No se pudo cargar la reserva.","error")}}}});Z==null||Z.addEventListener("click",async()=>{if(!x){o(d,"Selecciona una reserva para editar.","error");return}const e={name:(I.value||"").trim(),date:V.value,slot:q.value,person:R.value};if(!e.name||!e.date||!e.slot||!e.person){o(d,"Completa todos los campos.","error");return}try{await we(N(g,"reservas",x),e),o(d,"Reserva actualizada.","ok"),await F()}catch(r){console.error(r),o(d,"No se pudo actualizar.","error")}});G==null||G.addEventListener("click",()=>{ue()});X==null||X.addEventListener("click",async()=>{if(confirm("Seguro que quieres borrar todas las reservas?"))try{const r=await Le(ke(g,"reservas")),a=[];r.forEach(t=>{a.push(Ee(N(g,"reservas",t.id)))}),await Promise.all(a),o(d,"Todas las reservas fueron eliminadas.","ok"),ue(),await F()}catch(r){console.error(r),o(d,"No se pudieron borrar todas las reservas.","error")}});Y==null||Y.addEventListener("click",async()=>{const e=le();if(e){o(c,e,"error");return}try{await A(p,{state:"active",open_at:Be()},{merge:!0}),o(c,"Visita abierta desde ahora.","ok"),await w()}catch(r){o(c,"No se pudo abrir.","error"),console.error(r)}});j==null||j.addEventListener("click",async()=>{const e=le();if(e){o(c,e,"error");return}if(!P.value){o(c,"Selecciona fecha/hora en 'Publicar en'.","error");return}try{await A(p,{state:"scheduled",open_at:new Date(P.value)},{merge:!0}),o(c,"Apertura programada.","ok"),await w()}catch(r){o(c,"No se pudo programar apertura.","error"),console.error(r)}});J==null||J.addEventListener("click",async()=>{try{await A(p,{state:"concluded"},{merge:!0}),o(c,"Visita cerrada.","ok"),await w()}catch(e){o(c,"No se pudo cerrar.","error"),console.error(e)}});K==null||K.addEventListener("click",async()=>{const e=le();if(e){o(c,e,"error");return}const{start:r,end:a,visitStart:t,visitEnd:s}=xe(),i=`Desea guardar el inicio de reservas del ${ie(r,a)}?`;if(!await Ae(i)){o(c,"Corregir: no se guardaron cambios.","warn");return}const y=[...ye("am")].filter(L=>L!==2),O=[...ye("pm")].filter(L=>L!==2),$e={title:f.value||"Visita SC",start_date:r,end_date:a,visit_start_date:t,visit_end_date:s,am_days:y,pm_days:O};try{await A(p,$e,{merge:!0}),o(c,"Rango y dias guardados.","ok"),await w()}catch(L){o(c,"No se pudo guardar.","error"),console.error(L)}});H==null||H.addEventListener("click",async()=>{const e=((f==null?void 0:f.value)||"").trim();if(!e){o(C,"Escribe un titulo antes de actualizar.","error"),o(c,"Escribe un titulo antes de actualizar.","error");return}if(!await Ae(`Desea actualizar el titulo a "${e}"?`)){o(C,"Corregir: no se actualizo el titulo.","warn"),o(c,"Corregir: no se actualizo el titulo.","warn");return}try{(await ce(p)).exists()?await we(p,{title:e}):await A(p,{title:e},{merge:!0}),f.value=e,o(C,"Titulo actualizado.","ok"),o(c,"Titulo actualizado.","ok"),await w()}catch(a){o(C,"No se pudo actualizar el titulo.","error"),o(c,"No se pudo actualizar el titulo.","error"),console.error(a)}});const ae=document.getElementById("helpBtn"),u=document.getElementById("helpModal"),oe=document.getElementById("helpClose"),ne=document.getElementById("helpClose2"),se=document.getElementById("helpCopy");function Qe(){u==null||u.classList.remove("hidden")}function me(){u==null||u.classList.add("hidden")}ae==null||ae.addEventListener("click",Qe);oe==null||oe.addEventListener("click",me);ne==null||ne.addEventListener("click",me);u==null||u.addEventListener("click",e=>{e.target===u&&me()});se==null||se.addEventListener("click",async()=>{const e=["1) Define Inicio de visita y Fin de visita (periodo base).","2) Configura Titulo, Inicio/Fin de reservas y dias AM/PM. Pulsa Guardar rango/dias.","3) Si solo cambia el visitante, edita Titulo y pulsa Actualizar nombre.","4) Publica ahora con Abrir ahora, o programa con Publicar en + Programar apertura.","5) Verifica Estado actual y Resumen guardado.","6) En la pagina publica, si esta Abierta (o Programada y ya llego la hora), podran reservar.","7) Para terminar, pulsa Cerrar visita."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){await Ke()})();
