import"./style-DVQik4Xl.js";import{initializeApp as Q}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as G,doc as p,getDoc as V,updateDoc as h,serverTimestamp as z,addDoc as W,collection as H,query as Z,orderBy as J,limit as X,getDocs as U}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as ee,sendSignInLinkToEmail as te,signOut as ae,isSignInWithEmailLink as re,signInWithEmailLink as oe,onAuthStateChanged as ne}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const se={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},P=Q(se),l=G(P),v=ee(P),o=e=>document.getElementById(e),F=o("loginBox"),q=o("appBox"),ie=o("email"),b=o("sendLinkBtn"),y=o("loginMsg"),_=o("title"),f=o("openAt"),Y=o("startDate"),j=o("endDate"),ce=o("amDays"),de=o("pmDays"),w=o("openNowBtn"),D=o("scheduleBtn"),E=o("closeBtn"),S=o("saveWindowBtn"),k=o("newVisitBtn"),s=o("appMsg"),R=o("stateBadge"),I=o("stateDesc"),g=o("visitsTbody"),L=o("logoutBtn");let d=null;const le=["D","L","M","X","J","V","S"];function K(e,t){if(e){e.innerHTML="";for(let a=0;a<7;a++){const r=document.createElement("label");r.className="flex items-center gap-1";const i=document.createElement("input");i.type="checkbox",i.value=String(a),i.dataset.group=t,r.appendChild(i),r.appendChild(document.createTextNode(le[a])),e.appendChild(r)}}}K(ce,"am");K(de,"pm");function M(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(t=>Number(t.value)))}function O(e,t=[]){const a=new Set((t||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(r=>{r.checked=a.has(Number(r.value))})}function x(e){const t={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};R.textContent=e||"—",R.className=`px-2 py-0.5 rounded-lg text-white text-xs ${t[e]||"bg-zinc-600"}`}function n(e,t,a=""){e.textContent=t||"",e.className="text-sm mt-2 "+(a==="error"?"text-red-600":a==="ok"?"text-green-700":"text-zinc-600")}async function ue(){ne(v,async e=>{e?(F.classList.add("hidden"),q.classList.remove("hidden"),await m()):(F.classList.remove("hidden"),q.classList.add("hidden"))})}b==null||b.addEventListener("click",async()=>{const e=(ie.value||"").trim();if(!e){n(y,"Escribe tu correo.","error");return}n(y,"Enviando enlace…");const t={url:window.location.href,handleCodeInApp:!0};try{await te(v,e,t),window.localStorage.setItem("emailForSignIn",e),n(y,"Revisa tu correo y abre el enlace para entrar.","ok")}catch(a){n(y,"No se pudo enviar el enlace.","error"),console.error(a)}});L==null||L.addEventListener("click",async()=>{await ae(v),location.reload()});async function m(){try{const e=p(l,"settings","visitStatus"),t=await V(e);if(t.exists()){const a=t.data();x(a.state),I.textContent=a.state==="active"?"La visita está abierta. El formulario es visible.":a.state==="scheduled"?"Inscripciones programadas; aún no abren.":a.state==="concluded"?"La visita concluyó.":"Aún no hay visita programada."}else x("noscheduled"),I.textContent="Aún no hay visita programada."}catch(e){console.error("Error loading status:",e),x("noscheduled"),I.textContent="No se pudo leer el estado."}try{const e=Z(H(l,"visitas"),J("createdAt","desc"),X(10)),t=await U(e);g.innerHTML="",t.empty||(t.forEach(a=>{const r={id:a.id,...a.data()},i=document.createElement("tr");i.innerHTML=`
          <td class="border p-2">${r.id}</td>
          <td class="border p-2">${r.title||""}</td>
          <td class="border p-2">${r.startDate||""}</td>
          <td class="border p-2">${r.endDate||""}</td>
          <td class="border p-2">${r.isOpen?"true":"false"}</td>
          <td class="border p-2">${r.openAt?new Date(r.openAt.seconds*1e3).toLocaleString():""}</td>
          <td class="border p-2"><button data-id="${r.id}" class="px-2 py-1 border rounded">Editar</button></td>
        `,g.appendChild(i)}),await $(t.docs[0].id))}catch(e){console.error("Error fetching visits:",e),n(s,"No se pudieron cargar las visitas.","error")}}g==null||g.addEventListener("click",async e=>{const t=e.target.closest("button[data-id]");t&&await $(t.dataset.id)});async function $(e){try{const t=p(l,"visitas",e),a=await V(t);if(a.exists()){const r={id:a.id,...a.data()};if(d=r.id,_.value=r.title||"",Y.value=r.startDate||"",j.value=r.endDate||"",r.openAt&&r.openAt.seconds){const i=new Date(r.openAt.seconds*1e3).toISOString().slice(0,16);f.value=i}else f.value="";O("am",r.amDays||[]),O("pm",r.pmDays||[])}else n(s,"No se pudo cargar la visita.","error")}catch(t){console.error("Error loading visit by ID:",t),n(s,"No se pudo cargar la visita.","error")}}w==null||w.addEventListener("click",async()=>{if(d)try{const e=p(l,"visitas",d);await h(e,{isOpen:!0,openAt:z()}),n(s,"Visita abierta desde ahora.","ok"),await m()}catch(e){n(s,"No se pudo abrir.","error"),console.error(e)}});D==null||D.addEventListener("click",async()=>{if(!d||!f.value){n(s,"Selecciona fecha/hora en 'Abrir (open_at)'.","error");return}try{const e=p(l,"visitas",d);await h(e,{isOpen:!0,openAt:new Date(f.value)}),n(s,"Apertura programada.","ok"),await m()}catch(e){n(s,"No se pudo programar apertura.","error"),console.error(e)}});E==null||E.addEventListener("click",async()=>{if(d)try{const e=p(l,"visitas",d);await h(e,{isOpen:!1}),n(s,"Visita cerrada.","ok"),await m()}catch(e){n(s,"No se pudo cerrar.","error"),console.error(e)}});S==null||S.addEventListener("click",async()=>{if(!d)return;const e=Y.value,t=j.value;if(!e||!t){n(s,"Define inicio y fin.","error");return}const a=[...M("am")],r=[...M("pm")],i={title:_.value||"Visita SC",start_date:e,end_date:t,am_days:a,pm_days:r};try{const u=p(l,"visitas",d);await h(u,i),n(s,"Rango/días guardados.","ok"),await m()}catch(u){n(s,"No se pudo guardar.","error"),console.error(u)}});k==null||k.addEventListener("click",async()=>{const e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0"),i={title:"Nueva visita",startDate:`${t}-${a}-${r}`,endDate:`${t}-${a}-${r}`,amDays:[3,4,5,6,0],pmDays:[3,5],isOpen:!1,createdAt:z()};try{const u=await W(H(l,"visitas"),i);n(s,"Nueva visita creada.","ok"),await m(),await $(u.id)}catch(u){n(s,"No se pudo crear nueva visita.","error"),console.error(u)}});const A=document.getElementById("helpBtn"),c=document.getElementById("helpModal"),B=document.getElementById("helpClose"),C=document.getElementById("helpClose2"),N=document.getElementById("helpCopy");function pe(){c==null||c.classList.remove("hidden")}function T(){c==null||c.classList.add("hidden")}A==null||A.addEventListener("click",pe);B==null||B.addEventListener("click",T);C==null||C.addEventListener("click",T);c==null||c.addEventListener("click",e=>{e.target===c&&T()});N==null||N.addEventListener("click",async()=>{const e=["1) Crear nueva visita (queda cerrada).","2) Configura Título, Inicio/Fin y AM/PM. Pulsa Guardar rango/días.","3) Abrir ahora (visible inmediato) o Programar apertura con fecha/hora.","4) Verifica Estado: active o scheduled.","5) En la pública recarga; si está active y el día aplica, podrán reservar.","6) Al terminar, Cerrar (o deja que pase Fin)."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){if(re(v,window.location.href)){let t=window.localStorage.getItem("emailForSignIn");if(t||(t=window.prompt("Por favor, proporciona tu correo para confirmar tu inicio de sesión.")),t)try{const a=await oe(v,t,window.location.href);window.localStorage.removeItem("emailForSignIn")}catch(a){console.error("Error signing in with email link",a)}}await ue()})();
