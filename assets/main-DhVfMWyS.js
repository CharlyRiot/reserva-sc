import"./style-Dz1zmf2x.js";import{initializeApp as R}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as V,addDoc as W,collection as k,query as N,where as $,getDocs as _,doc as z,getDoc as K,orderBy as Q}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";const Y={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},j=R(Y),S=V(j),o=s=>document.getElementById(s),d=o("reservaForm"),L=o("formMsg"),m=o("submitBtn"),G=o("name"),i=o("date"),l=o("person"),c=o("slot"),y=o("optAM"),x=o("optPM"),g=o("optSC"),b=o("optEsposa"),I=o("successBox"),P=o("errorBox"),Z=o("thanksName"),H=o("thanksDate"),J=o("thanksPerson"),U=o("thanksTime"),E=o("retryBtn"),w=o("newBtn"),D=o("statusBox"),v=o("statusText"),h=o("statusTitle"),M=o("reservasList"),A=o("reservasEmpty");let q=new Set,F=new Set;function p(s,t=""){L.textContent=s||"",L.className="text-sm mt-1 "+(t==="error"?"text-red-600":t==="warn"?"text-amber-600":"text-zinc-600")}"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js");window.addEventListener("beforeinstallprompt",s=>{s.preventDefault()});async function X(){var s,t;try{const n=z(S,"settings","visitStatus"),a=await K(n),e=a.exists()?a.data():null,r=(s=e==null?void 0:e.open_at)!=null&&s.toDate?e.open_at.toDate():(t=e==null?void 0:e.open_at)!=null&&t.seconds?new Date(e.open_at.seconds*1e3):null,u=e&&(e.state==="active"||e.state==="scheduled"&&r&&r<=new Date);if(!e||!u){if(d.classList.add("hidden"),D.classList.remove("hidden"),!e){h.textContent="Sin fecha programada",v.textContent="Aún no se pueden hacer reservaciones. ¡Gracias por estar atento!";return}e.state==="scheduled"?(h.textContent="Reservas aún no abiertas",r?v.textContent=`Las reservas abren el ${r.toLocaleString()}.`:v.textContent=e.message||"Vuelve pronto."):e.state==="concluded"?(h.textContent="La visita concluyó",v.textContent=e.message||"Aún no hay fecha de la próxima visita."):(h.textContent="Sin fecha programada",v.textContent=e.message||"Aún no hay fecha de la próxima visita.");return}D.classList.add("hidden"),d.classList.remove("hidden"),e.start_date&&(i.min=e.start_date),e.end_date&&(i.max=e.end_date),q=new Set((e.am_days||[]).map(Number)),F=new Set((e.pm_days||[]).map(Number))}catch(n){console.error("Error loading status:",n),d.classList.add("hidden"),D.classList.remove("hidden"),h.textContent="Estado no disponible",v.textContent="No se pudo cargar el estado. Intenta más tarde."}}function B(){const s=i.value;if(!s)return;const t=new Date(s+"T00:00").getDay();if(t===2){y.disabled=!0,x.disabled=!0,y.textContent="Mañana — No disponible",x.textContent="Tarde — No disponible",c.value="",p("Los martes no hay servicio.","warn"),C();return}const n=q.has(t),a=F.has(t);y.disabled=!n,x.disabled=!a,y.textContent=n?"Mañana (9:00 a.m.)":"Mañana — No disponible",x.textContent=a?"Tarde (4:30 p.m.)":"Tarde — No disponible",(c.value==="AM"&&!n||c.value==="PM"&&!a)&&(c.value="")}function C(){const s=!!i.value,t=!!c.value,n=l.value,a=n?document.querySelector(`#person option[value="${n}"]`):null,e=!!n&&a&&!a.disabled,r=g.disabled&&b.disabled;r?(l.value="",p("No hay cupos para esa fecha y turno.","warn")):n&&a&&a.disabled?(l.value="",p("Esa persona se ocupó para ese día/turno. Elige otra.","warn")):(L.textContent.includes("cupo")||L.textContent.includes("ocupó"))&&p(""),m.disabled=!(s&&t&&e&&!r)}(function(){const t=new Date,n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),e=String(t.getDate()).padStart(2,"0");i.min||(i.min=`${n}-${a}-${e}`)})();async function f(){const s=i.value;if(!s)return;if(B(),[g,b].forEach(n=>{n.disabled=!1,n.textContent=n.value==="SC"?"Superintendente de Circuito":"Esposa del SC"}),!c.value){C();return}if(new Date(s+"T00:00").getDay()===2){C();return}const t=N(k(S,"reservas"),$("date","==",s),$("slot","==",c.value));try{const n=await _(t),a=new Set;n.forEach(e=>{a.add(e.data().person)}),a.has("SC")&&(g.disabled=!0,g.textContent="Superintendente de Circuito — Ocupado"),a.has("Esposa")&&(b.disabled=!0,b.textContent="Esposa del SC — Ocupado")}catch(n){p("No se pudo verificar disponibilidad.","error"),console.error(n)}C()}function ee(s){return s==="SC"?"SC":"Esposa"}function te(s){const t=(s||"").trim().split(/\s+/).filter(Boolean);if(!t.length)return"—";const n=t[0],a=t[1]||"",e=a?`${a[0].toUpperCase()}.`:"";return`${n}${e?" "+e:""}`}function se(s){const t=["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"],n=new Date(s+"T00:00").getDay();return t[n]||""}async function ne(){if(!(!M||!A)){M.innerHTML="",A.classList.remove("hidden");try{const s=N(k(S,"reservas"),Q("date","asc")),t=await _(s),n=[];if(t.forEach(a=>{const e=a.data();n.push(e)}),n.sort((a,e)=>{if(a.date!==e.date)return a.date.localeCompare(e.date);const r={AM:0,PM:1};return(r[a.slot]??9)-(r[e.slot]??9)}),!n.length)return;A.classList.add("hidden"),n.forEach(a=>{const e=document.createElement("li"),r=se(a.date),u=a.slot||"AM",T=ee(a.person),O=te(a.name);e.textContent=`${r} ${u} Reservado por ${O} Con ${T}`,M.appendChild(e)})}catch(s){console.error("Error loading reservas:",s)}}}i==null||i.addEventListener("change",()=>{B(),f()});c==null||c.addEventListener("change",()=>{f()});l==null||l.addEventListener("change",C);d==null||d.addEventListener("submit",async s=>{if(s.preventDefault(),p(""),m.disabled=!0,m.textContent="Reservando...",!i.value||!c.value||!l.value){p("Completa fecha, turno y persona.","error"),m.disabled=!1,m.textContent="Reservar cupo";return}const t={name:(G.value||"").trim(),person:l.value,date:i.value,slot:c.value||"AM"};try{await W(k(S,"reservas"),t);const n=t.name.split(" ")[0]||t.name;Z.textContent=n;const[a,e,r]=t.date.split("-");H.textContent=`${r}/${e}/${a}`,J.textContent=t.person==="SC"?"el Superintendente de Circuito":"la Esposa del SC",U.textContent=t.slot==="PM"?"4:30 p.m.":"9:00 a.m.",d.classList.add("hidden"),I.classList.remove("hidden");const u=document.getElementById("doneAnim");if(u&&u.play)try{u.stop(),u.play()}catch{}}catch(n){console.error("Error al guardar:",n),d.classList.add("hidden"),P.classList.remove("hidden"),l.value="",await f()}m.disabled=!1,m.textContent="Reservar cupo"});E==null||E.addEventListener("click",s=>{s.preventDefault(),P.classList.add("hidden"),d.classList.remove("hidden"),l.value="",f()});w==null||w.addEventListener("click",s=>{s.preventDefault(),I.classList.add("hidden"),d.classList.remove("hidden"),d.reset(),p(""),f();const t=document.getElementById("doneAnim");t&&t.stop&&t.stop()});(async function(){await X(),d.classList.contains("hidden")||(i.value&&B(),f()),await ne()})();
