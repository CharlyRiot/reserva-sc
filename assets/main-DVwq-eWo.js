import"./style-Dz1zmf2x.js";import{initializeApp as N}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as $,addDoc as P,collection as M,query as F,where as D,getDocs as O,doc as q,getDoc as R}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";const W={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},z=N(W),E=$(z),s=n=>document.getElementById(n),i=s("reservaForm"),g=s("formMsg"),u=s("submitBtn"),K=s("name"),r=s("date"),c=s("person"),d=s("slot"),A=s("optAM"),k=s("optPM"),x=s("optSC"),C=s("optEsposa"),B=s("successBox"),T=s("errorBox"),Q=s("thanksName"),V=s("thanksDate"),Y=s("thanksPerson"),j=s("thanksTime"),b=s("retryBtn"),y=s("newBtn"),S=s("statusBox"),v=s("statusText"),h=s("statusTitle");let _=new Set,I=new Set;function p(n,t=""){g.textContent=n||"",g.className="text-sm mt-1 "+(t==="error"?"text-red-600":t==="warn"?"text-amber-600":"text-zinc-600")}"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js");window.addEventListener("beforeinstallprompt",n=>{n.preventDefault()});async function G(){var n,t;try{const a=q(E,"settings","visitStatus"),o=await R(a),e=o.exists()?o.data():null,l=(n=e==null?void 0:e.open_at)!=null&&n.toDate?e.open_at.toDate():(t=e==null?void 0:e.open_at)!=null&&t.seconds?new Date(e.open_at.seconds*1e3):null,m=e&&(e.state==="active"||e.state==="scheduled"&&l&&l<=new Date);if(!e||!m){if(i.classList.add("hidden"),S.classList.remove("hidden"),!e){h.textContent="Sin fecha programada",v.textContent="Aún no se pueden hacer reservaciones. ¡Gracias por estar atento!";return}e.state==="scheduled"?(h.textContent="Reservas aún no abiertas",l?v.textContent=`Las reservas abren el ${l.toLocaleString()}.`:v.textContent=e.message||"Vuelve pronto."):e.state==="concluded"?(h.textContent="La visita concluyó",v.textContent=e.message||"Aún no hay fecha de la próxima visita."):(h.textContent="Sin fecha programada",v.textContent=e.message||"Aún no hay fecha de la próxima visita.");return}S.classList.add("hidden"),i.classList.remove("hidden"),e.start_date&&(r.min=e.start_date),e.end_date&&(r.max=e.end_date),_=new Set((e.am_days||[]).map(Number)),I=new Set((e.pm_days||[]).map(Number))}catch(a){console.error("Error loading status:",a),i.classList.add("hidden"),S.classList.remove("hidden"),h.textContent="Estado no disponible",v.textContent="No se pudo cargar el estado. Intenta más tarde."}}function w(){const n=r.value;if(!n)return;const t=new Date(n+"T00:00").getDay(),a=_.has(t),o=I.has(t);A.disabled=!a,k.disabled=!o,A.textContent=a?"Mañana (9:00 a.m.)":"Mañana — No disponible",k.textContent=o?"Tarde (4:30 p.m.)":"Tarde — No disponible",(d.value==="AM"&&!a||d.value==="PM"&&!o)&&(d.value="")}function L(){const n=!!r.value,t=!!d.value,a=c.value,o=a?document.querySelector(`#person option[value="${a}"]`):null,e=!!a&&o&&!o.disabled,l=x.disabled&&C.disabled;l?(c.value="",p("No hay cupos para esa fecha y turno.","warn")):a&&o&&o.disabled?(c.value="",p("Esa persona se ocupó para ese día/turno. Elige otra.","warn")):(g.textContent.includes("cupo")||g.textContent.includes("ocupó"))&&p(""),u.disabled=!(n&&t&&e&&!l)}(function(){const t=new Date,a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),e=String(t.getDate()).padStart(2,"0");r.min||(r.min=`${a}-${o}-${e}`)})();async function f(){const n=r.value;if(!n)return;if(w(),[x,C].forEach(a=>{a.disabled=!1,a.textContent=a.value==="SC"?"Superintendente de Circuito":"Esposa del SC"}),!d.value){L();return}const t=F(M(E,"reservas"),D("date","==",n),D("slot","==",d.value));try{const a=await O(t),o=new Set;a.forEach(e=>{o.add(e.data().person)}),o.has("SC")&&(x.disabled=!0,x.textContent="Superintendente de Circuito — Ocupado"),o.has("Esposa")&&(C.disabled=!0,C.textContent="Esposa del SC — Ocupado")}catch(a){p("No se pudo verificar disponibilidad.","error"),console.error(a)}L()}r==null||r.addEventListener("change",()=>{w(),f()});d==null||d.addEventListener("change",()=>{f()});c==null||c.addEventListener("change",L);i==null||i.addEventListener("submit",async n=>{if(n.preventDefault(),p(""),u.disabled=!0,u.textContent="Reservando...",!r.value||!d.value||!c.value){p("Completa fecha, turno y persona.","error"),u.disabled=!1,u.textContent="Reservar cupo";return}const t={name:(K.value||"").trim(),person:c.value,date:r.value,slot:d.value||"AM"};try{await P(M(E,"reservas"),t);const a=t.name.split(" ")[0]||t.name;Q.textContent=a;const[o,e,l]=t.date.split("-");V.textContent=`${l}/${e}/${o}`,Y.textContent=t.person==="SC"?"el Superintendente de Circuito":"la Esposa del SC",j.textContent=t.slot==="PM"?"4:30 p.m.":"9:00 a.m.",i.classList.add("hidden"),B.classList.remove("hidden");const m=document.getElementById("doneAnim");if(m&&m.play)try{m.stop(),m.play()}catch{}}catch(a){console.error("Error al guardar:",a),i.classList.add("hidden"),T.classList.remove("hidden"),c.value="",await f()}u.disabled=!1,u.textContent="Reservar cupo"});b==null||b.addEventListener("click",n=>{n.preventDefault(),T.classList.add("hidden"),i.classList.remove("hidden"),c.value="",f()});y==null||y.addEventListener("click",n=>{n.preventDefault(),B.classList.add("hidden"),i.classList.remove("hidden"),i.reset(),p(""),f();const t=document.getElementById("doneAnim");t&&t.stop&&t.stop()});(async function(){await G(),i.classList.contains("hidden")||(r.value&&w(),f())})();
