import"./style-Dz1zmf2x.js";import{initializeApp as M}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as O,doc as $,setDoc as v,serverTimestamp as j,getDoc as H}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as K,sendSignInLinkToEmail as Q,signOut as Y,isSignInWithEmailLink as G,signInWithEmailLink as R,onAuthStateChanged as W}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const Z={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},q=M(Z),J=O(q),l=K(q),o=e=>document.getElementById(e),N=o("loginBox"),T=o("appBox"),U=o("email"),h=o("sendLinkBtn"),p=o("loginMsg"),C=o("title"),d=o("openAt"),A=o("startDate"),B=o("endDate"),X=o("amDays"),ee=o("pmDays"),y=o("openNowBtn"),f=o("scheduleBtn"),w=o("closeBtn"),b=o("saveWindowBtn"),i=o("appMsg"),F=o("stateBadge"),S=o("stateDesc"),k=o("logoutBtn"),u=$(J,"settings","visitStatus"),te=["D","L","M","X","J","V","S"];function z(e,a){if(e){e.innerHTML="";for(let n=0;n<7;n++){const t=document.createElement("label");t.className="flex items-center gap-1";const c=document.createElement("input");c.type="checkbox",c.value=String(n),c.dataset.group=a,t.appendChild(c),t.appendChild(document.createTextNode(te[n])),e.appendChild(t)}}}z(X,"am");z(ee,"pm");function V(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(a=>Number(a.value)))}function g(e,a=[]){const n=new Set((a||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(t=>{t.checked=n.has(Number(t.value))})}function E(e){const a={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};F.textContent=e||"—",F.className=`px-2 py-0.5 rounded-lg text-white text-xs ${a[e]||"bg-zinc-600"}`}function r(e,a,n=""){e.textContent=a||"",e.className="text-sm mt-2 "+(n==="error"?"text-red-600":n==="ok"?"text-green-700":"text-zinc-600")}async function ae(){W(l,async e=>{e?(N.classList.add("hidden"),T.classList.remove("hidden"),await m()):(N.classList.remove("hidden"),T.classList.add("hidden"))})}h==null||h.addEventListener("click",async()=>{const e=(U.value||"").trim();if(!e){r(p,"Escribe tu correo.","error");return}r(p,"Enviando enlace…");const a={url:window.location.href,handleCodeInApp:!0};try{await Q(l,e,a),window.localStorage.setItem("emailForSignIn",e),r(p,"Revisa tu correo y abre el enlace para entrar.","ok")}catch(n){r(p,"No se pudo enviar el enlace.","error"),console.error(n)}});k==null||k.addEventListener("click",async()=>{await Y(l),location.reload()});async function m(){var e,a;try{const n=await H(u);if(n.exists()){const t=n.data();E(t.state),S.textContent=t.state==="active"?"La visita esta abierta. El formulario es visible.":t.state==="scheduled"?"Apertura programada; aun no abre.":t.state==="concluded"?"La visita concluyo.":"Aun no hay visita programada.",C.value=t.title||"Visita SC",A.value=t.start_date||"",B.value=t.end_date||"",(e=t.open_at)!=null&&e.toDate?d.value=t.open_at.toDate().toISOString().slice(0,16):(a=t.open_at)!=null&&a.seconds?d.value=new Date(t.open_at.seconds*1e3).toISOString().slice(0,16):d.value="",g("am",t.am_days||[]),g("pm",t.pm_days||[])}else E("noscheduled"),S.textContent="Aun no hay visita programada.",C.value="Visita SC",d.value="",A.value="",B.value="",g("am",[]),g("pm",[])}catch(n){console.error("Error loading status:",n),E("noscheduled"),S.textContent="No se pudo leer el estado."}}y==null||y.addEventListener("click",async()=>{try{await v(u,{state:"active",open_at:j()},{merge:!0}),r(i,"Visita abierta desde ahora.","ok"),await m()}catch(e){r(i,"No se pudo abrir.","error"),console.error(e)}});f==null||f.addEventListener("click",async()=>{if(!d.value){r(i,"Selecciona fecha/hora en 'Publicar en'.","error");return}try{await v(u,{state:"scheduled",open_at:new Date(d.value)},{merge:!0}),r(i,"Apertura programada.","ok"),await m()}catch(e){r(i,"No se pudo programar apertura.","error"),console.error(e)}});w==null||w.addEventListener("click",async()=>{try{await v(u,{state:"concluded"},{merge:!0}),r(i,"Visita cerrada.","ok"),await m()}catch(e){r(i,"No se pudo cerrar.","error"),console.error(e)}});b==null||b.addEventListener("click",async()=>{const e=A.value,a=B.value;if(!e||!a){r(i,"Define inicio y fin.","error");return}const n=[...V("am")],t=[...V("pm")],c={title:C.value||"Visita SC",start_date:e,end_date:a,am_days:n,pm_days:t};try{await v(u,c,{merge:!0}),r(i,"Rango y dias guardados.","ok"),await m()}catch(P){r(i,"No se pudo guardar.","error"),console.error(P)}});const I=document.getElementById("helpBtn"),s=document.getElementById("helpModal"),x=document.getElementById("helpClose"),L=document.getElementById("helpClose2"),D=document.getElementById("helpCopy");function ne(){s==null||s.classList.remove("hidden")}function _(){s==null||s.classList.add("hidden")}I==null||I.addEventListener("click",ne);x==null||x.addEventListener("click",_);L==null||L.addEventListener("click",_);s==null||s.addEventListener("click",e=>{e.target===s&&_()});D==null||D.addEventListener("click",async()=>{const e=["1) Crear nueva visita (queda cerrada).","2) Configura Título, Inicio/Fin y AM/PM. Pulsa Guardar rango/días.","3) Abrir ahora (visible inmediato) o Programar apertura con fecha/hora.","4) Verifica Estado: active o scheduled.","5) En la pública recarga; si está active y el día aplica, podrán reservar.","6) Al terminar, Cerrar (o deja que pase Fin)."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){if(G(l,window.location.href)){let a=window.localStorage.getItem("emailForSignIn");if(a||(a=window.prompt("Por favor, proporciona tu correo para confirmar tu inicio de sesión.")),a)try{const n=await R(l,a,window.location.href);window.localStorage.removeItem("emailForSignIn")}catch(n){console.error("Error signing in with email link",n)}}await ae()})();
