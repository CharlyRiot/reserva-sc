import"./style-Dz1zmf2x.js";import{initializeApp as R}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as V,addDoc as W,collection as T,query as _,where as N,getDocs as I,doc as z,getDoc as K,orderBy as Q}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";const Y={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},j=R(Y),w=V(j),o=e=>document.getElementById(e),d=o("reservaForm"),E=o("formMsg"),m=o("submitBtn"),G=o("name"),i=o("date"),l=o("person"),c=o("slot"),x=o("optAM"),b=o("optPM"),L=o("optSC"),S=o("optEsposa"),P=o("successBox"),q=o("errorBox"),Z=o("thanksName"),H=o("thanksDate"),J=o("thanksPerson"),U=o("thanksTime"),D=o("retryBtn"),M=o("newBtn"),A=o("statusBox"),v=o("statusText"),C=o("statusTitle"),k=o("reservasList"),B=o("reservasEmpty");let F=new Set,O=new Set;function X(e){const n=(e==null?void 0:e.visit_start_date)||(e==null?void 0:e.start_date)||"",a=(e==null?void 0:e.visit_end_date)||(e==null?void 0:e.end_date)||"";return{visitStart:n,visitEnd:a}}function u(e,n=""){E.textContent=e||"",E.className="text-sm mt-1 "+(n==="error"?"text-red-600":n==="warn"?"text-amber-600":"text-zinc-600")}"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault()});async function ee(){var e,n;try{const a=z(w,"settings","visitStatus"),s=await K(a),t=s.exists()?s.data():null,r=(e=t==null?void 0:t.open_at)!=null&&e.toDate?t.open_at.toDate():(n=t==null?void 0:t.open_at)!=null&&n.seconds?new Date(t.open_at.seconds*1e3):null,p=t&&(t.state==="active"||t.state==="scheduled"&&r&&r<=new Date);if(!t||!p){if(d.classList.add("hidden"),A.classList.remove("hidden"),!t){C.textContent="Sin fecha programada",v.textContent="Aún no se pueden hacer reservaciones. ¡Gracias por estar atento!";return}t.state==="scheduled"?(C.textContent="Reservas aún no abiertas",r?v.textContent=`Las reservas abren el ${r.toLocaleString()}.`:v.textContent=t.message||"Vuelve pronto."):t.state==="concluded"?(C.textContent="La visita concluyó",v.textContent=t.message||"Aún no hay fecha de la próxima visita."):(C.textContent="Sin fecha programada",v.textContent=t.message||"Aún no hay fecha de la próxima visita.");return}A.classList.add("hidden"),d.classList.remove("hidden");const{visitStart:h,visitEnd:g}=X(t);h&&(i.min=h),g&&(i.max=g),F=new Set((t.am_days||[]).map(Number)),O=new Set((t.pm_days||[]).map(Number))}catch(a){console.error("Error loading status:",a),d.classList.add("hidden"),A.classList.remove("hidden"),C.textContent="Estado no disponible",v.textContent="No se pudo cargar el estado. Intenta más tarde."}}function $(){const e=i.value;if(!e)return;const n=new Date(e+"T00:00").getDay();if(n===2){x.disabled=!0,b.disabled=!0,x.textContent="Mañana — No disponible",b.textContent="Tarde — No disponible",c.value="",u("Los martes no hay servicio.","warn"),y();return}const a=F.has(n),s=O.has(n);x.disabled=!a,b.disabled=!s,x.textContent=a?"Mañana (9:00 a.m.)":"Mañana — No disponible",b.textContent=s?"Tarde (4:30 p.m.)":"Tarde — No disponible",(c.value==="AM"&&!a||c.value==="PM"&&!s)&&(c.value="")}function y(){const e=!!i.value,n=!!c.value,a=l.value,s=a?document.querySelector(`#person option[value="${a}"]`):null,t=!!a&&s&&!s.disabled,r=L.disabled&&S.disabled;r?(l.value="",u("No hay cupos para esa fecha y turno.","warn")):a&&s&&s.disabled?(l.value="",u("Esa persona se ocupó para ese día/turno. Elige otra.","warn")):(E.textContent.includes("cupo")||E.textContent.includes("ocupó"))&&u(""),m.disabled=!(e&&n&&t&&!r)}(function(){const n=new Date,a=n.getFullYear(),s=String(n.getMonth()+1).padStart(2,"0"),t=String(n.getDate()).padStart(2,"0");i.min||(i.min=`${a}-${s}-${t}`)})();async function f(){const e=i.value;if(!e)return;if($(),[L,S].forEach(a=>{a.disabled=!1,a.textContent=a.value==="SC"?"Superintendente de Circuito":"Esposa del SC"}),!c.value){y();return}if(new Date(e+"T00:00").getDay()===2){y();return}const n=_(T(w,"reservas"),N("date","==",e),N("slot","==",c.value));try{const a=await I(n),s=new Set;a.forEach(t=>{s.add(t.data().person)}),s.has("SC")&&(L.disabled=!0,L.textContent="Superintendente de Circuito — Ocupado"),s.has("Esposa")&&(S.disabled=!0,S.textContent="Esposa del SC — Ocupado")}catch(a){u("No se pudo verificar disponibilidad.","error"),console.error(a)}y()}function te(e){return e==="SC"?"SC":"Esposa"}function ne(e){const n=(e||"").trim().split(/\s+/).filter(Boolean);if(!n.length)return"—";const a=n[0],s=n[1]||"",t=s?`${s[0].toUpperCase()}.`:"";return`${a}${t?" "+t:""}`}function ae(e){const n=["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"],a=new Date(e+"T00:00").getDay();return n[a]||""}async function se(){if(!(!k||!B)){k.innerHTML="",B.classList.remove("hidden");try{const e=_(T(w,"reservas"),Q("date","asc")),n=await I(e),a=[];if(n.forEach(s=>{const t=s.data();a.push(t)}),a.sort((s,t)=>{if(s.date!==t.date)return s.date.localeCompare(t.date);const r={AM:0,PM:1};return(r[s.slot]??9)-(r[t.slot]??9)}),!a.length)return;B.classList.add("hidden"),a.forEach(s=>{const t=document.createElement("li"),r=ae(s.date),p=s.slot||"AM",h=te(s.person),g=ne(s.name);t.textContent=`${r} ${p} Reservado por ${g} Con ${h}`,k.appendChild(t)})}catch(e){console.error("Error loading reservas:",e)}}}i==null||i.addEventListener("change",()=>{$(),f()});c==null||c.addEventListener("change",()=>{f()});l==null||l.addEventListener("change",y);d==null||d.addEventListener("submit",async e=>{if(e.preventDefault(),u(""),m.disabled=!0,m.textContent="Reservando...",!i.value||!c.value||!l.value){u("Completa fecha, turno y persona.","error"),m.disabled=!1,m.textContent="Reservar cupo";return}const n={name:(G.value||"").trim(),person:l.value,date:i.value,slot:c.value||"AM"};try{await W(T(w,"reservas"),n);const a=n.name.split(" ")[0]||n.name;Z.textContent=a;const[s,t,r]=n.date.split("-");H.textContent=`${r}/${t}/${s}`,J.textContent=n.person==="SC"?"el Superintendente de Circuito":"la Esposa del SC",U.textContent=n.slot==="PM"?"4:30 p.m.":"9:00 a.m.",d.classList.add("hidden"),P.classList.remove("hidden");const p=document.getElementById("doneAnim");if(p&&p.play)try{p.stop(),p.play()}catch{}}catch(a){console.error("Error al guardar:",a),d.classList.add("hidden"),q.classList.remove("hidden"),l.value="",await f()}m.disabled=!1,m.textContent="Reservar cupo"});D==null||D.addEventListener("click",e=>{e.preventDefault(),q.classList.add("hidden"),d.classList.remove("hidden"),l.value="",f()});M==null||M.addEventListener("click",e=>{e.preventDefault(),P.classList.add("hidden"),d.classList.remove("hidden"),d.reset(),u(""),f();const n=document.getElementById("doneAnim");n&&n.stop&&n.stop()});(async function(){await ee(),d.classList.contains("hidden")||(i.value&&$(),f()),await se()})();
