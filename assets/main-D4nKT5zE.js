import"./style-DVQik4Xl.js";import{initializeApp as _}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as P,addDoc as $,collection as M,query as F,where as A,getDocs as O,doc as q,getDoc as R}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";const W={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},z=_(W),E=P(z),s=a=>document.getElementById(a),r=s("reservaForm"),g=s("formMsg"),l=s("submitBtn"),K=s("name"),o=s("date"),d=s("person"),i=s("slot"),D=s("optAM"),k=s("optPM"),x=s("optSC"),C=s("optEsposa"),B=s("successBox"),T=s("errorBox"),Q=s("thanksName"),V=s("thanksDate"),Y=s("thanksPerson"),j=s("thanksTime"),b=s("retryBtn"),y=s("newBtn"),S=s("statusBox"),m=s("statusText"),v=s("statusTitle");let I=new Set,N=new Set;function u(a,t=""){g.textContent=a||"",g.className="text-sm mt-1 "+(t==="error"?"text-red-600":t==="warn"?"text-amber-600":"text-zinc-600")}"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js");window.addEventListener("beforeinstallprompt",a=>{a.preventDefault()});async function G(){try{const a=q(E,"settings","visitStatus"),t=await R(a),e=t.exists()?t.data():null;if(!e||e.state!=="active"){if(r.classList.add("hidden"),S.classList.remove("hidden"),!e){v.textContent="Sin fecha programada",m.textContent="Aún no se pueden hacer reservaciones. ¡Gracias por estar atento!";return}e.state==="scheduled"?(v.textContent="Reservas aún no abiertas",m.textContent=e.message||"Vuelve pronto."):e.state==="concluded"?(v.textContent="La visita concluyó",m.textContent=e.message||"Aún no hay fecha de la próxima visita."):(v.textContent="Sin fecha programada",m.textContent=e.message||"Aún no hay fecha de la próxima visita.");return}S.classList.add("hidden"),r.classList.remove("hidden"),e.start_date&&(o.min=e.start_date),e.end_date&&(o.max=e.end_date),I=new Set((e.am_days||[]).map(Number)),N=new Set((e.pm_days||[]).map(Number))}catch(a){console.error("Error loading status:",a),r.classList.add("hidden"),S.classList.remove("hidden"),v.textContent="Estado no disponible",m.textContent="No se pudo cargar el estado. Intenta más tarde."}}function w(){const a=o.value;if(!a)return;const t=new Date(a+"T00:00").getDay(),e=I.has(t),n=N.has(t);D.disabled=!e,k.disabled=!n,D.textContent=e?"Mañana (9:00 a.m.)":"Mañana — No disponible",k.textContent=n?"Tarde (4:30 p.m.)":"Tarde — No disponible",(i.value==="AM"&&!e||i.value==="PM"&&!n)&&(i.value="")}function L(){const a=!!o.value,t=!!i.value,e=d.value,n=e?document.querySelector(`#person option[value="${e}"]`):null,c=!!e&&n&&!n.disabled,f=x.disabled&&C.disabled;f?(d.value="",u("No hay cupos para esa fecha y turno.","warn")):e&&n&&n.disabled?(d.value="",u("Esa persona se ocupó para ese día/turno. Elige otra.","warn")):(g.textContent.includes("cupo")||g.textContent.includes("ocupó"))&&u(""),l.disabled=!(a&&t&&c&&!f)}(function(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0");o.min||(o.min=`${e}-${n}-${c}`)})();async function p(){const a=o.value;if(!a)return;if(w(),[x,C].forEach(e=>{e.disabled=!1,e.textContent=e.value==="SC"?"Superintendente de Circuito":"Esposa del SC"}),!i.value){L();return}const t=F(M(E,"reservas"),A("date","==",a),A("slot","==",i.value));try{const e=await O(t),n=new Set;e.forEach(c=>{n.add(c.data().person)}),n.has("SC")&&(x.disabled=!0,x.textContent="Superintendente de Circuito — Ocupado"),n.has("Esposa")&&(C.disabled=!0,C.textContent="Esposa del SC — Ocupado")}catch(e){u("No se pudo verificar disponibilidad.","error"),console.error(e)}L()}o==null||o.addEventListener("change",()=>{w(),p()});i==null||i.addEventListener("change",()=>{p()});d==null||d.addEventListener("change",L);r==null||r.addEventListener("submit",async a=>{if(a.preventDefault(),u(""),l.disabled=!0,l.textContent="Reservando...",!o.value||!i.value||!d.value){u("Completa fecha, turno y persona.","error"),l.disabled=!1,l.textContent="Reservar cupo";return}const t={name:(K.value||"").trim(),person:d.value,date:o.value,slot:i.value||"AM"};try{await $(M(E,"reservas"),t);const e=t.name.split(" ")[0]||t.name;Q.textContent=e;const[n,c,f]=t.date.split("-");V.textContent=`${f}/${c}/${n}`,Y.textContent=t.person==="SC"?"el Superintendente de Circuito":"la Esposa del SC",j.textContent=t.slot==="PM"?"4:30 p.m.":"9:00 a.m.",r.classList.add("hidden"),B.classList.remove("hidden");const h=document.getElementById("doneAnim");if(h&&h.play)try{h.stop(),h.play()}catch{}}catch(e){console.error("Error al guardar:",e),r.classList.add("hidden"),T.classList.remove("hidden"),d.value="",await p()}l.disabled=!1,l.textContent="Reservar cupo"});b==null||b.addEventListener("click",a=>{a.preventDefault(),T.classList.add("hidden"),r.classList.remove("hidden"),d.value="",p()});y==null||y.addEventListener("click",a=>{a.preventDefault(),B.classList.add("hidden"),r.classList.remove("hidden"),r.reset(),u(""),p();const t=document.getElementById("doneAnim");t&&t.stop&&t.stop()});(async function(){await G(),r.classList.contains("hidden")||(o.value&&w(),p())})();
