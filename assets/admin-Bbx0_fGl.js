import"./style-Dz1zmf2x.js";import{initializeApp as se}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as ie,doc as f,deleteDoc as U,getDoc as X,updateDoc as ce,getDocs as ee,collection as te,setDoc as I,serverTimestamp as de,query as le,orderBy as ue}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as me,sendSignInLinkToEmail as pe,signOut as ae,isSignInWithEmailLink as ve,signInWithEmailLink as ge,onAuthStateChanged as fe}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const ye={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},re=se(ye),u=ie(re),g=me(re),oe="biosistem@gmail.com",n=e=>document.getElementById(e),D=n("loginBox"),C=n("appBox"),he=n("email"),A=n("sendLinkBtn"),m=n("loginMsg"),j=n("title"),p=n("openAt"),K=n("startDate"),Q=n("endDate"),be=n("amDays"),we=n("pmDays"),B=n("openNowBtn"),N=n("scheduleBtn"),_=n("closeBtn"),M=n("saveWindowBtn"),l=n("appMsg"),W=n("stateBadge"),T=n("stateDesc"),q=n("logoutBtn"),v=n("reservasTbody"),E=n("resName"),k=n("resDate"),S=n("resSlot"),L=n("resPerson"),F=n("resUpdateBtn"),$=n("resClearBtn"),z=n("resDeleteAllBtn"),c=n("resMsg"),h=f(u,"settings","visitStatus");let y=null;const Z=[{label:"L",value:1},{label:"M",value:2},{label:"X",value:3},{label:"J",value:4},{label:"V",value:5},{label:"S",value:6},{label:"D",value:0}];function ne(e,a){if(e){e.innerHTML="";for(let r=0;r<Z.length;r++){const t=Z[r],s=document.createElement("label");s.className="flex items-center gap-1";const i=document.createElement("input");i.type="checkbox",i.value=String(t.value),i.dataset.group=a,t.value===2&&(i.disabled=!0,s.className+=" text-zinc-400",s.title="Martes no disponible."),s.appendChild(i),s.appendChild(document.createTextNode(t.label)),e.appendChild(s)}}}ne(be,"am");ne(we,"pm");function J(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(a=>Number(a.value)))}function w(e,a=[]){const r=new Set((a||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(t=>{t.checked=r.has(Number(t.value))})}function P(e){const a={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};W.textContent=e||"—",W.className=`px-2 py-0.5 rounded-lg text-white text-xs ${a[e]||"bg-zinc-600"}`}function o(e,a,r=""){e.textContent=a||"",e.className="text-sm mt-2 "+(r==="error"?"text-red-600":r==="ok"?"text-green-700":"text-zinc-600")}async function Ee(){fe(g,async e=>{e&&e.email===oe?(D.classList.add("hidden"),C.classList.remove("hidden"),await b()):e?(o(m,"Este correo no tiene acceso.","error"),await ae(g),D.classList.remove("hidden"),C.classList.add("hidden")):(D.classList.remove("hidden"),C.classList.add("hidden"))})}A==null||A.addEventListener("click",async()=>{const e=(he.value||"").trim();if(e.toLowerCase()!==oe){o(m,"Solo el administrador puede acceder.","error");return}if(!e){o(m,"Escribe tu correo.","error");return}o(m,"Enviando enlace…");const a={url:window.location.href,handleCodeInApp:!0};try{await pe(g,e,a),window.localStorage.setItem("emailForSignIn",e),o(m,"Revisa tu correo y abre el enlace para entrar.","ok")}catch(r){o(m,"No se pudo enviar el enlace.","error"),console.error(r)}});q==null||q.addEventListener("click",async()=>{await ae(g),location.reload()});async function b(){var e,a;try{const r=await X(h);if(r.exists()){const t=r.data();P(t.state),T.textContent=t.state==="active"?"La visita esta abierta. El formulario es visible.":t.state==="scheduled"?"Apertura programada; aun no abre.":t.state==="concluded"?"La visita concluyo.":"Aun no hay visita programada.",j.value=t.title||"Visita SC",K.value=t.start_date||"",Q.value=t.end_date||"",(e=t.open_at)!=null&&e.toDate?p.value=t.open_at.toDate().toISOString().slice(0,16):(a=t.open_at)!=null&&a.seconds?p.value=new Date(t.open_at.seconds*1e3).toISOString().slice(0,16):p.value="",w("am",t.am_days||[]),w("pm",t.pm_days||[])}else P("noscheduled"),T.textContent="Aun no hay visita programada.",j.value="Visita SC",p.value="",K.value="",Q.value="",w("am",[]),w("pm",[])}catch(r){console.error("Error loading status:",r),P("noscheduled"),T.textContent="No se pudo leer el estado."}await x()}function Y(){y=null,E&&(E.value=""),k&&(k.value=""),S&&(S.value="AM"),L&&(L.value="SC"),c&&o(c,"")}async function x(){if(v){v.innerHTML="";try{const e=le(te(u,"reservas"),ue("date","asc"));(await ee(e)).forEach(r=>{const t=r.data(),s=document.createElement("tr");s.innerHTML=`
        <td>${t.date||""}</td>
        <td>${t.slot||""}</td>
        <td>${t.person||""}</td>
        <td>${t.name||""}</td>
        <td>
          <button data-edit="${r.id}" class="px-2 py-1 border rounded">Editar</button>
          <button data-delete="${r.id}" class="px-2 py-1 border rounded">Eliminar</button>
        </td>
      `,v.appendChild(s)})}catch(e){console.error("Error fetching reservas:",e),o(c,"No se pudieron cargar las reservas.","error")}}}v==null||v.addEventListener("click",async e=>{const a=e.target.closest("button[data-edit]"),r=e.target.closest("button[data-delete]");if(!(!a&&!r)){if(r){const t=r.dataset.delete;if(!t||!confirm("Eliminar esta reserva?"))return;try{await U(f(u,"reservas",t)),o(c,"Reserva eliminada.","ok"),y===t&&Y(),await x()}catch(i){console.error(i),o(c,"No se pudo eliminar.","error")}return}if(a){const t=a.dataset.edit;if(!t)return;try{const s=await X(f(u,"reservas",t));if(!s.exists())return;const i=s.data();y=t,E.value=i.name||"",k.value=i.date||"",S.value=i.slot||"AM",L.value=i.person||"SC",o(c,"Editando reserva seleccionada.","ok")}catch(s){console.error(s),o(c,"No se pudo cargar la reserva.","error")}}}});F==null||F.addEventListener("click",async()=>{if(!y){o(c,"Selecciona una reserva para editar.","error");return}const e={name:(E.value||"").trim(),date:k.value,slot:S.value,person:L.value};if(!e.name||!e.date||!e.slot||!e.person){o(c,"Completa todos los campos.","error");return}try{await ce(f(u,"reservas",y),e),o(c,"Reserva actualizada.","ok"),await x()}catch(a){console.error(a),o(c,"No se pudo actualizar.","error")}});$==null||$.addEventListener("click",()=>{Y()});z==null||z.addEventListener("click",async()=>{if(confirm("Seguro que quieres borrar todas las reservas?"))try{const a=await ee(te(u,"reservas")),r=[];a.forEach(t=>{r.push(U(f(u,"reservas",t.id)))}),await Promise.all(r),o(c,"Todas las reservas fueron eliminadas.","ok"),Y(),await x()}catch(a){console.error(a),o(c,"No se pudieron borrar todas las reservas.","error")}});B==null||B.addEventListener("click",async()=>{try{await I(h,{state:"active",open_at:de()},{merge:!0}),o(l,"Visita abierta desde ahora.","ok"),await b()}catch(e){o(l,"No se pudo abrir.","error"),console.error(e)}});N==null||N.addEventListener("click",async()=>{if(!p.value){o(l,"Selecciona fecha/hora en 'Publicar en'.","error");return}try{await I(h,{state:"scheduled",open_at:new Date(p.value)},{merge:!0}),o(l,"Apertura programada.","ok"),await b()}catch(e){o(l,"No se pudo programar apertura.","error"),console.error(e)}});_==null||_.addEventListener("click",async()=>{try{await I(h,{state:"concluded"},{merge:!0}),o(l,"Visita cerrada.","ok"),await b()}catch(e){o(l,"No se pudo cerrar.","error"),console.error(e)}});M==null||M.addEventListener("click",async()=>{const e=K.value,a=Q.value;if(!e||!a){o(l,"Define inicio y fin.","error");return}const r=[...J("am")],t=[...J("pm")],s={title:j.value||"Visita SC",start_date:e,end_date:a,am_days:r,pm_days:t};try{await I(h,s,{merge:!0}),o(l,"Rango y dias guardados.","ok"),await b()}catch(i){o(l,"No se pudo guardar.","error"),console.error(i)}});const R=document.getElementById("helpBtn"),d=document.getElementById("helpModal"),V=document.getElementById("helpClose"),H=document.getElementById("helpClose2"),O=document.getElementById("helpCopy");function ke(){d==null||d.classList.remove("hidden")}function G(){d==null||d.classList.add("hidden")}R==null||R.addEventListener("click",ke);V==null||V.addEventListener("click",G);H==null||H.addEventListener("click",G);d==null||d.addEventListener("click",e=>{e.target===d&&G()});O==null||O.addEventListener("click",async()=>{const e=["1) Crear nueva visita (queda cerrada).","2) Configura Título, Inicio/Fin y AM/PM. Pulsa Guardar rango/días.","3) Abrir ahora (visible inmediato) o Programar apertura con fecha/hora.","4) Verifica Estado: active o scheduled.","5) En la pública recarga; si está active y el día aplica, podrán reservar.","6) Al terminar, Cerrar (o deja que pase Fin)."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){if(ve(g,window.location.href)){let a=window.localStorage.getItem("emailForSignIn");if(a||(a=window.prompt("Por favor, proporciona tu correo para confirmar tu inicio de sesión.")),a)try{const r=await ge(g,a,window.location.href);window.localStorage.removeItem("emailForSignIn")}catch(r){console.error("Error signing in with email link",r)}}await Ee()})();
