import"./style-Dz1zmf2x.js";import{initializeApp as ee}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as te,doc as w,deleteDoc as ae,getDoc as Z,updateDoc as re,setDoc as I,serverTimestamp as oe,query as ne,collection as se,orderBy as ie,getDocs as ce}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as de,sendSignInLinkToEmail as le,signOut as ue,isSignInWithEmailLink as pe,signInWithEmailLink as me,onAuthStateChanged as ve}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const ge={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},J=ee(ge),m=te(J),v=de(J),o=e=>document.getElementById(e),K=o("loginBox"),Q=o("appBox"),fe=o("email"),L=o("sendLinkBtn"),h=o("loginMsg"),R=o("title"),u=o("openAt"),V=o("startDate"),H=o("endDate"),ye=o("amDays"),he=o("pmDays"),D=o("openNowBtn"),C=o("scheduleBtn"),A=o("closeBtn"),B=o("saveWindowBtn"),l=o("appMsg"),Y=o("stateBadge"),N=o("stateDesc"),_=o("logoutBtn"),p=o("reservasTbody"),E=o("resName"),k=o("resDate"),S=o("resSlot"),x=o("resPerson"),T=o("resUpdateBtn"),M=o("resClearBtn"),c=o("resMsg"),f=w(m,"settings","visitStatus");let g=null;const G=[{label:"L",value:1},{label:"M",value:2},{label:"X",value:3},{label:"J",value:4},{label:"V",value:5},{label:"S",value:6},{label:"D",value:0}];function U(e,a){if(e){e.innerHTML="";for(let r=0;r<G.length;r++){const t=G[r],s=document.createElement("label");s.className="flex items-center gap-1";const i=document.createElement("input");i.type="checkbox",i.value=String(t.value),i.dataset.group=a,t.value===2&&(i.disabled=!0,s.className+=" text-zinc-400",s.title="Martes no disponible."),s.appendChild(i),s.appendChild(document.createTextNode(t.label)),e.appendChild(s)}}}U(ye,"am");U(he,"pm");function W(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(a=>Number(a.value)))}function b(e,a=[]){const r=new Set((a||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(t=>{t.checked=r.has(Number(t.value))})}function F(e){const a={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};Y.textContent=e||"—",Y.className=`px-2 py-0.5 rounded-lg text-white text-xs ${a[e]||"bg-zinc-600"}`}function n(e,a,r=""){e.textContent=a||"",e.className="text-sm mt-2 "+(r==="error"?"text-red-600":r==="ok"?"text-green-700":"text-zinc-600")}async function be(){ve(v,async e=>{e?(K.classList.add("hidden"),Q.classList.remove("hidden"),await y()):(K.classList.remove("hidden"),Q.classList.add("hidden"))})}L==null||L.addEventListener("click",async()=>{const e=(fe.value||"").trim();if(!e){n(h,"Escribe tu correo.","error");return}n(h,"Enviando enlace…");const a={url:window.location.href,handleCodeInApp:!0};try{await le(v,e,a),window.localStorage.setItem("emailForSignIn",e),n(h,"Revisa tu correo y abre el enlace para entrar.","ok")}catch(r){n(h,"No se pudo enviar el enlace.","error"),console.error(r)}});_==null||_.addEventListener("click",async()=>{await ue(v),location.reload()});async function y(){var e,a;try{const r=await Z(f);if(r.exists()){const t=r.data();F(t.state),N.textContent=t.state==="active"?"La visita esta abierta. El formulario es visible.":t.state==="scheduled"?"Apertura programada; aun no abre.":t.state==="concluded"?"La visita concluyo.":"Aun no hay visita programada.",R.value=t.title||"Visita SC",V.value=t.start_date||"",H.value=t.end_date||"",(e=t.open_at)!=null&&e.toDate?u.value=t.open_at.toDate().toISOString().slice(0,16):(a=t.open_at)!=null&&a.seconds?u.value=new Date(t.open_at.seconds*1e3).toISOString().slice(0,16):u.value="",b("am",t.am_days||[]),b("pm",t.pm_days||[])}else F("noscheduled"),N.textContent="Aun no hay visita programada.",R.value="Visita SC",u.value="",V.value="",H.value="",b("am",[]),b("pm",[])}catch(r){console.error("Error loading status:",r),F("noscheduled"),N.textContent="No se pudo leer el estado."}await O()}function X(){g=null,E&&(E.value=""),k&&(k.value=""),S&&(S.value="AM"),x&&(x.value="SC"),c&&n(c,"")}async function O(){if(p){p.innerHTML="";try{const e=ne(se(m,"reservas"),ie("date","asc"));(await ce(e)).forEach(r=>{const t=r.data(),s=document.createElement("tr");s.innerHTML=`
        <td>${t.date||""}</td>
        <td>${t.slot||""}</td>
        <td>${t.person||""}</td>
        <td>${t.name||""}</td>
        <td>
          <button data-edit="${r.id}" class="px-2 py-1 border rounded">Editar</button>
          <button data-delete="${r.id}" class="px-2 py-1 border rounded">Eliminar</button>
        </td>
      `,p.appendChild(s)})}catch(e){console.error("Error fetching reservas:",e),n(c,"No se pudieron cargar las reservas.","error")}}}p==null||p.addEventListener("click",async e=>{const a=e.target.closest("button[data-edit]"),r=e.target.closest("button[data-delete]");if(!(!a&&!r)){if(r){const t=r.dataset.delete;if(!t||!confirm("Eliminar esta reserva?"))return;try{await ae(w(m,"reservas",t)),n(c,"Reserva eliminada.","ok"),g===t&&X(),await O()}catch(i){console.error(i),n(c,"No se pudo eliminar.","error")}return}if(a){const t=a.dataset.edit;if(!t)return;try{const s=await Z(w(m,"reservas",t));if(!s.exists())return;const i=s.data();g=t,E.value=i.name||"",k.value=i.date||"",S.value=i.slot||"AM",x.value=i.person||"SC",n(c,"Editando reserva seleccionada.","ok")}catch(s){console.error(s),n(c,"No se pudo cargar la reserva.","error")}}}});T==null||T.addEventListener("click",async()=>{if(!g){n(c,"Selecciona una reserva para editar.","error");return}const e={name:(E.value||"").trim(),date:k.value,slot:S.value,person:x.value};if(!e.name||!e.date||!e.slot||!e.person){n(c,"Completa todos los campos.","error");return}try{await re(w(m,"reservas",g),e),n(c,"Reserva actualizada.","ok"),await O()}catch(a){console.error(a),n(c,"No se pudo actualizar.","error")}});M==null||M.addEventListener("click",()=>{X()});D==null||D.addEventListener("click",async()=>{try{await I(f,{state:"active",open_at:oe()},{merge:!0}),n(l,"Visita abierta desde ahora.","ok"),await y()}catch(e){n(l,"No se pudo abrir.","error"),console.error(e)}});C==null||C.addEventListener("click",async()=>{if(!u.value){n(l,"Selecciona fecha/hora en 'Publicar en'.","error");return}try{await I(f,{state:"scheduled",open_at:new Date(u.value)},{merge:!0}),n(l,"Apertura programada.","ok"),await y()}catch(e){n(l,"No se pudo programar apertura.","error"),console.error(e)}});A==null||A.addEventListener("click",async()=>{try{await I(f,{state:"concluded"},{merge:!0}),n(l,"Visita cerrada.","ok"),await y()}catch(e){n(l,"No se pudo cerrar.","error"),console.error(e)}});B==null||B.addEventListener("click",async()=>{const e=V.value,a=H.value;if(!e||!a){n(l,"Define inicio y fin.","error");return}const r=[...W("am")],t=[...W("pm")],s={title:R.value||"Visita SC",start_date:e,end_date:a,am_days:r,pm_days:t};try{await I(f,s,{merge:!0}),n(l,"Rango y dias guardados.","ok"),await y()}catch(i){n(l,"No se pudo guardar.","error"),console.error(i)}});const $=document.getElementById("helpBtn"),d=document.getElementById("helpModal"),z=document.getElementById("helpClose"),q=document.getElementById("helpClose2"),P=document.getElementById("helpCopy");function we(){d==null||d.classList.remove("hidden")}function j(){d==null||d.classList.add("hidden")}$==null||$.addEventListener("click",we);z==null||z.addEventListener("click",j);q==null||q.addEventListener("click",j);d==null||d.addEventListener("click",e=>{e.target===d&&j()});P==null||P.addEventListener("click",async()=>{const e=["1) Crear nueva visita (queda cerrada).","2) Configura Título, Inicio/Fin y AM/PM. Pulsa Guardar rango/días.","3) Abrir ahora (visible inmediato) o Programar apertura con fecha/hora.","4) Verifica Estado: active o scheduled.","5) En la pública recarga; si está active y el día aplica, podrán reservar.","6) Al terminar, Cerrar (o deja que pase Fin)."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){if(pe(v,window.location.href)){let a=window.localStorage.getItem("emailForSignIn");if(a||(a=window.prompt("Por favor, proporciona tu correo para confirmar tu inicio de sesión.")),a)try{const r=await me(v,a,window.location.href);window.localStorage.removeItem("emailForSignIn")}catch(r){console.error("Error signing in with email link",r)}}await be()})();
