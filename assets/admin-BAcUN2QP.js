import"./style-Dz1zmf2x.js";import{initializeApp as O}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getFirestore as $,doc as j,setDoc as h,serverTimestamp as H,getDoc as K}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getAuth as Q,sendSignInLinkToEmail as Y,signOut as G,isSignInWithEmailLink as R,signInWithEmailLink as W,onAuthStateChanged as Z}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";const J={apiKey:"AIzaSyCkQisqMEqmKrAbhBPl0xroQQFZFYT0TkY",authDomain:"reserva-sc.firebaseapp.com",projectId:"reserva-sc",storageBucket:"reserva-sc.firebasestorage.app",messagingSenderId:"651352627398",appId:"1:651352627398:web:8120205020de4f6a89dfc7",measurementId:"G-3KZTLF3SBB"},M=O(J),U=$(M),u=Q(M),o=e=>document.getElementById(e),T=o("loginBox"),F=o("appBox"),X=o("email"),y=o("sendLinkBtn"),g=o("loginMsg"),A=o("title"),d=o("openAt"),B=o("startDate"),_=o("endDate"),ee=o("amDays"),te=o("pmDays"),f=o("openNowBtn"),b=o("scheduleBtn"),w=o("closeBtn"),S=o("saveWindowBtn"),i=o("appMsg"),z=o("stateBadge"),k=o("stateDesc"),E=o("logoutBtn"),m=j(U,"settings","visitStatus"),V=[{label:"L",value:1},{label:"M",value:2},{label:"X",value:3},{label:"J",value:4},{label:"V",value:5},{label:"S",value:6},{label:"D",value:0}];function P(e,t){if(e){e.innerHTML="";for(let n=0;n<V.length;n++){const a=V[n],c=document.createElement("label");c.className="flex items-center gap-1";const l=document.createElement("input");l.type="checkbox",l.value=String(a.value),l.dataset.group=t,a.value===2&&(l.disabled=!0,c.className+=" text-zinc-400",c.title="Martes no disponible."),c.appendChild(l),c.appendChild(document.createTextNode(a.label)),e.appendChild(c)}}}P(ee,"am");P(te,"pm");function q(e){return new Set([...document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]:checked`)].map(t=>Number(t.value)))}function v(e,t=[]){const n=new Set((t||[]).map(Number));document.querySelectorAll(`input[type="checkbox"][data-group="${e}"]`).forEach(a=>{a.checked=n.has(Number(a.value))})}function I(e){const t={active:"bg-green-600",scheduled:"bg-amber-600",concluded:"bg-zinc-600",noscheduled:"bg-zinc-600"};z.textContent=e||"—",z.className=`px-2 py-0.5 rounded-lg text-white text-xs ${t[e]||"bg-zinc-600"}`}function r(e,t,n=""){e.textContent=t||"",e.className="text-sm mt-2 "+(n==="error"?"text-red-600":n==="ok"?"text-green-700":"text-zinc-600")}async function ae(){Z(u,async e=>{e?(T.classList.add("hidden"),F.classList.remove("hidden"),await p()):(T.classList.remove("hidden"),F.classList.add("hidden"))})}y==null||y.addEventListener("click",async()=>{const e=(X.value||"").trim();if(!e){r(g,"Escribe tu correo.","error");return}r(g,"Enviando enlace…");const t={url:window.location.href,handleCodeInApp:!0};try{await Y(u,e,t),window.localStorage.setItem("emailForSignIn",e),r(g,"Revisa tu correo y abre el enlace para entrar.","ok")}catch(n){r(g,"No se pudo enviar el enlace.","error"),console.error(n)}});E==null||E.addEventListener("click",async()=>{await G(u),location.reload()});async function p(){var e,t;try{const n=await K(m);if(n.exists()){const a=n.data();I(a.state),k.textContent=a.state==="active"?"La visita esta abierta. El formulario es visible.":a.state==="scheduled"?"Apertura programada; aun no abre.":a.state==="concluded"?"La visita concluyo.":"Aun no hay visita programada.",A.value=a.title||"Visita SC",B.value=a.start_date||"",_.value=a.end_date||"",(e=a.open_at)!=null&&e.toDate?d.value=a.open_at.toDate().toISOString().slice(0,16):(t=a.open_at)!=null&&t.seconds?d.value=new Date(a.open_at.seconds*1e3).toISOString().slice(0,16):d.value="",v("am",a.am_days||[]),v("pm",a.pm_days||[])}else I("noscheduled"),k.textContent="Aun no hay visita programada.",A.value="Visita SC",d.value="",B.value="",_.value="",v("am",[]),v("pm",[])}catch(n){console.error("Error loading status:",n),I("noscheduled"),k.textContent="No se pudo leer el estado."}}f==null||f.addEventListener("click",async()=>{try{await h(m,{state:"active",open_at:H()},{merge:!0}),r(i,"Visita abierta desde ahora.","ok"),await p()}catch(e){r(i,"No se pudo abrir.","error"),console.error(e)}});b==null||b.addEventListener("click",async()=>{if(!d.value){r(i,"Selecciona fecha/hora en 'Publicar en'.","error");return}try{await h(m,{state:"scheduled",open_at:new Date(d.value)},{merge:!0}),r(i,"Apertura programada.","ok"),await p()}catch(e){r(i,"No se pudo programar apertura.","error"),console.error(e)}});w==null||w.addEventListener("click",async()=>{try{await h(m,{state:"concluded"},{merge:!0}),r(i,"Visita cerrada.","ok"),await p()}catch(e){r(i,"No se pudo cerrar.","error"),console.error(e)}});S==null||S.addEventListener("click",async()=>{const e=B.value,t=_.value;if(!e||!t){r(i,"Define inicio y fin.","error");return}const n=[...q("am")],a=[...q("pm")],c={title:A.value||"Visita SC",start_date:e,end_date:t,am_days:n,pm_days:a};try{await h(m,c,{merge:!0}),r(i,"Rango y dias guardados.","ok"),await p()}catch(l){r(i,"No se pudo guardar.","error"),console.error(l)}});const x=document.getElementById("helpBtn"),s=document.getElementById("helpModal"),L=document.getElementById("helpClose"),D=document.getElementById("helpClose2"),C=document.getElementById("helpCopy");function ne(){s==null||s.classList.remove("hidden")}function N(){s==null||s.classList.add("hidden")}x==null||x.addEventListener("click",ne);L==null||L.addEventListener("click",N);D==null||D.addEventListener("click",N);s==null||s.addEventListener("click",e=>{e.target===s&&N()});C==null||C.addEventListener("click",async()=>{const e=["1) Crear nueva visita (queda cerrada).","2) Configura Título, Inicio/Fin y AM/PM. Pulsa Guardar rango/días.","3) Abrir ahora (visible inmediato) o Programar apertura con fecha/hora.","4) Verifica Estado: active o scheduled.","5) En la pública recarga; si está active y el día aplica, podrán reservar.","6) Al terminar, Cerrar (o deja que pase Fin)."].join(`
`);try{await navigator.clipboard.writeText(e)}catch{}});(async function(){if(R(u,window.location.href)){let t=window.localStorage.getItem("emailForSignIn");if(t||(t=window.prompt("Por favor, proporciona tu correo para confirmar tu inicio de sesión.")),t)try{const n=await W(u,t,window.location.href);window.localStorage.removeItem("emailForSignIn")}catch(n){console.error("Error signing in with email link",n)}}await ae()})();
